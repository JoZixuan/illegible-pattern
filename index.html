<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Illegible Pattern</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas-add-mix-blend-mode@1.4.1/dist/html2canvas.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script> -->
    <!-- <script src="sketch.js"></script> -->
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon-05.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@100..900&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script src="iro.min.js"></script>
  <!-- <script src="script.js"></script> -->
</head>
<body>
 

   
       
        <!-- <div id="advance-popup"> 
            <span class="close-popup" style="
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 20px;
            font-weight: 100;">
  
            ✕
            
            </span>
           
                <span style="text-decoration: underline; text-underline-offset: 2px;">Drag and drop</span> on the blank canvas<br>to start your pattern! <br> <br>You can <span style="text-decoration: underline; text-underline-offset: 2px;">drag</span> them around <br>and <span style="text-decoration: underline; text-underline-offset: 3px;">double-click</span> to edit. 
            </div> -->

         <button id="about" class="control-input"> ? </button>  
         <button id="chart" class="control-input"> ! </button>  
         <button id="meaning" class="control-input" >字</button>
         <!-- <button id="text-alignment" class="styled-button yellowback control-input"></button>  -->
         <label class="toggle-wrapper">
            <input type="checkbox" id="toggle-switch" class="control-input">
            <span class="slider"></span>
          </label>
          <button id="greyscale" class="styled-button inkback control-input"></button>  

          <div id="picker1" class="control-input"></div>
          <!-- <input type="color" id="color-picker" class="control-input" value="#FF0000"> -->
         <!-- Font Size Slider -->
        <div class="slider-group">
            <label for="font-size-slider"></label>
            <input type="range" id="font-size-slider" class="control-input" min="10" max="800" step="1" value="16">
            <span id="font-size-value" class="slider-bubble">16</span>
        </div>
        <!-- Line-height Slider vertical spacing -->
        <div class="slider-group">
          <label for="line-height-slider"></label>
          <input type="range" id="line-height-slider" class="control-input" min="0.1" max="3" step="0.01" value="1">
          <span id="line-height-value" class="slider-bubble">1</span>
        </div>
        <!-- letter spacing Slider horizontal spacing -->
        <div class="slider-group">
            <label for="letter-spacing-slider"></label>
            <input type="range" id="letter-spacing-slider" class="control-input" min="-40" max="350" step="1" value="0">
            <span id="letter-spacing-value" class="slider-bubble">0</span>
            </div>

            <!-- ratio -->
        <div class="slider-group control-input">
        <input type="range" id="ratio" min="0.5" max="2.5" step="0.05" value="1">
        </div>
        
        <!-- slant -->
        <div class="slider-group control-input">
          <input type="range" id="slant" min="-40" max="40" step="1" value="0">
          <span id="slant-value" class="slider-bubble">0</span>
        </div>

        <button id="decoration">〓</button>
        <button id="import-font" class="darkblueback control-input"></button>
        <button id="save-png-btn" class="yellowback control-input"></button> 
        <button id="delete" class="control-input"><img src="delete.svg" /></button> 
         <button id="gallery-btn" class="control-input pinkback"></button> 
         <button id="instruction-btn" class="control-input">         </button>
       
 
<!---labels created individually-->
<div id="button-label-container" style="display: block;">
  <div id = "about-btn-label">About</div>
  <div id = "chart-btn-label" style="margin-top: 29px;">Chart</div>
  <div id = "legible-btn-label" style="margin-top: 27px;">Legible</div>
  <div id = "shape-btn-label" style="margin-top: 33px;">Shape</div>
  <div id = "greyscale-btn-label" style="margin-top: 39px;">Greyscale</div>
  <div id = "underline-btn-label" style="margin-top: 27px;">Underline</div>
  <div id = "import-btn-label" style="margin-top: 27px;">Import Font</div>
  <div id = "save-btn-label" style="margin-top: 30px;">Save</div>
  <div id = "delete-btn-label" style="margin-top: 27px;">Delete</div>
  <div id = "gallery-btn-label" style="margin-top: 28px;">Gallery</div>
  <div id = "instruction-btn-label" style="margin-top: 26px;">Hint</div>
</div>

<div id="slider-label-container" style="display: block;">
  <span>Color Picker</span>
  <span class="slider-label" data-for="font-size-slider">Font Size</span>
  <span class="slider-label" data-for="line-height-slider">Line Height</span>
  <span class="slider-label" data-for="letter-spacing-slider">Letter Spacing</span>
  <span class="slider-label" data-for="slant">Slant</span>
  <span class="slider-label" data-for="ratio">Ratio</span>
</div>
 
 <!-- A BIG CONTAINER -->

    <div id="blended-content" class="container">

     


        
    </div>   <!---------- CONTAINER END ------->
</body>


<!----------------- JAVASCRIPT PART ------------------>
<!----------------- JAVASCRIPT PART ------------------>
<!----------------- JAVASCRIPT PART ------------------>
    <script>

let startX, startY, isSelecting = false;
let selections = [];
let currentSelection = null;

let suppressClearOnce = false; // Prevent the next click from clearing selection right after creation

// ===== Layout step 1: separate sliders (top) and buttons (left) =====
// ===== Layout step 1: separate sliders (top) and buttons (left) =====
// ===== Layout step 1: separate sliders (top) and buttons (left) =====
(function setupBasicTwoBars() {
  const styleEl = document.createElement('style');
  styleEl.textContent = `
    /* Top slider bar: layout only (no visual changes) */
    .slider-container{
      position: fixed; 
      left: 15px; 
      right: 20px; 
      top: 14px; 
      z-index: 900;  
      outline: 2px solid #f3e24d;  
      height:27px;
      padding: 8px 10px;
      display: flex; align-items: center; gap: 22px;
      background: white; border-radius: 10px;
    }
    .slider-container .slider-group{ display: inline-flex; align-items: center; }

    /* Left vertical button rail: layout only (no visual changes) */
    .button-rail{
      position: fixed; top: 74px; left: 15px; width: 45px; bottom: 500px; z-index: 901;
      display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 10px 3px; background: white; outline: 2px solid #f3e24d;  border-radius: 10px; height: 476px;
    }
    .button-rail .control-input, .button-rail button, .button-rail .toggle-wrapper{ margin: 0; }
    .button-rail .toggle-wrapper{ width: 36px; }

  
  `;
  document.head.appendChild(styleEl);


  // Create new containers
  const sliderWrap = document.createElement('div');
  sliderWrap.className = 'slider-container';
document.body.appendChild(sliderWrap);

  const buttonRail = document.createElement('div');
  buttonRail.className = 'button-rail';
document.body.appendChild(buttonRail);

  // Helpers to move nodes
  const moveToSlider = (sel) => { const el = document.querySelector(sel); if (!el) return; const group = el.closest('.slider-group'); sliderWrap.appendChild(group || el); };
  const moveElToSlider = (sel) => { const el = document.querySelector(sel); if (el) sliderWrap.appendChild(el); };

// Move color picker first, then sliders, to avoid overlap
moveElToSlider('#picker1');
const p1 = document.getElementById('picker1');
if (p1) {
  p1.style.width = '350px';
  p1.style.flex = '0 0 auto'; // prevent being covered or squashed
}

moveToSlider('#font-size-slider');
moveToSlider('#line-height-slider');
moveToSlider('#letter-spacing-slider');
moveToSlider('#ratio');
moveToSlider('#slant');

  // Move buttons to left vertical rail (top→bottom order)
  ['#about','#chart','#meaning','#toggle-switch','#greyscale','#decoration','#import-font','#save-png-btn','#delete','#gallery-btn','#instruction-btn']
    .forEach(sel => { const el = document.querySelector(sel); if (!el) return; buttonRail.appendChild(el.closest('.toggle-wrapper') || el); });

  // Initialize and position rail labels now that the rail exists
  try { ensureRailLabels(); positionRailLabels(); } catch (e) {}
})();

// Helper to manage current selection and .is-selected class
function setCurrentSelection(sel) {
  document.querySelectorAll('.selection.is-selected').forEach(s => s.classList.remove('is-selected'));
  if (!sel) {
    const active = document.activeElement;
    if (active && typeof active.closest === 'function' && active.closest('.selection')) {
      active.blur(); // remove focus-within state
    }
  }
  currentSelection = sel || null;
  if (currentSelection) {
    currentSelection.classList.add('is-selected');
  }
}

// Dummy text options
const dummyTexts = [
  "QRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRQRASQRASRQRASRQRQRQSRSQRQSRQSRSRQSRSSSRQSQRSQRSQQRASQRASRQRSRSQRQSRQSRQRSRQSRSSSRQSQRSQQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRQRASQRASRQRASRQRQRQSRSQRQSRQSRRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQSSSRQSQRSQRSQQRASQRASRQRASRQRASRSRRRAAAASRSRRARARARAARRRSSSSSAAAQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRRSQQRASQRASRQRASRQRASRSRRRAAAASRSRRARARARAARRRSSSSSAAAQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRQRASQRASRQRASRQRQRQSRSQRQSRQSRSRQSRSSSRQSQRSQRSQQRASQRASRQRSRSQRQSRQSRQRSRQSRSSSRQSQRSQQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRQRASQRASRQRASRQRQRQSRSQRQSRQSRRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQSSSRQSQRSQRSQQRASQRASRQRASRQRASRSRRRAAAASRSRRARARARAARRRSSSSSAAAQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRRSQQRASQRASRQRASRQRASRSRRRAAAASRSRRARARARAARRRSSSSSAAAQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRQRASQRASRQRASRQRQRQSRSQRQSRQSRSRQSRSSSRQSQRSQRSQQRASQRASRQRSRSQRQSRQSRQRSRQSRSSSRQSQRSQQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRQRASQRASRQRASRQRQRQSRSQRQSRQSRRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQSSSRQSQRSQRSQQRASQRASRQRASRQRASRSRRRAAAASRSRRARARARAARRRSSSSSAAAQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRRSQQRASQRASRQRASRQRASRSRRRAAAASRSRRARARARAARRRSSSSSAAAQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRASQRASRQRASRQRASASRQRQRQSRSQRQSRQSRQRSRQSRSSSRQSQRSQRSQQRASQRASRQRASRQRQRQSRSQRQSRQSRQRS",
    "FLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFFLFLFLFLFLFLFLFFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFLFFLFLFLFLFLFLFLFFLFLFLFLFLFLFLFFLFLFLFLF",
    "yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy",
    "rsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrssrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsrsr",
    "SUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSUSU",
    "WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW",
    "WaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaWaW",
    "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
    "SSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS",
    "vxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvxvx",
    "0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E0E",
"EFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGnoEFGno",
"HIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUVHIJKLMNOPTUV",    
"klmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklmklm",
"1234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567123456712345671234567",
"ijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijijij",
"fghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghByfghBy"
];

// Prevent default browser selection
document.addEventListener("mousedown", (e) => {
    // Ignore clicks on sliders, color picker, and input elements
    if (e.target.closest(".control-input")) {
        return; // Do nothing if interacting with UI elements
    }

    // Allow interaction inside editable content
    if (e.target.closest(".selection-content")) {
        return;
    }

    // Clear selection when clicking empty canvas (inside #blended-content but not on a .selection)
    if ((e.target.id === 'blended-content' || (e.target.closest && e.target.closest('#blended-content'))) && !e.target.closest('.selection')) {
      setCurrentSelection(null);
    }

    if (!e.target.classList.contains("selection")) {
        e.preventDefault(); // Only block text selection if not clicking on an editable box
    }

    if (e.button !== 0) return; // Ignore right-clicks or middle-clicks

    let clickedElement = document.elementFromPoint(e.clientX, e.clientY);
    if (clickedElement.closest(".selection")) {
        setCurrentSelection(clickedElement.closest(".selection"));
        updateSliders(currentSelection);
        updateToggleFromSelection(currentSelection);
        isSelecting = false;
        return; // Prevent new selection when dragging an existing one
    }

    startX = e.clientX;
    startY = e.clientY;
    isSelecting = true;

    document.addEventListener("mousemove", detectDrag);
    document.addEventListener("mouseup", cancelIfNotDragged);
});


function detectDrag(e) {
  if (!isSelecting) return;
  if (Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5) {
    createSelection(startX, startY);
    document.removeEventListener("mousemove", detectDrag);
    document.removeEventListener("mouseup", cancelIfNotDragged);
  }
}

function cancelIfNotDragged() {
  isSelecting = false;
  document.removeEventListener("mousemove", detectDrag);
  document.removeEventListener("mouseup", cancelIfNotDragged);
}

function createSelection(x, y) {
    
    let selection = document.createElement("div");
    selection.classList.add("selection");
    selection.style.left = `${x}px`;
    selection.style.top = `${y}px`;
    selection.style.position = "absolute";
    selection.style.backgroundColor = "transparent";
    selection.style.lineHeight="0.9"
    selection.style.mixBlendMode = "multiply";
    selection.style.padding = "0px";
    selection.style.minWidth = "50px";
    selection.style.minHeight = "30px";
    selection.style.resize = "both";
    selection.style.overflow = "hidden";
    selection.style.fontFamily = (window.userFontName || "shape-font");
    selection.tabIndex = 0;
    selection.style.resize = "none"; // Disable native resizer
    
    const customHandle = document.createElement("div");
    customHandle.classList.add("custom-resize-handle");
    selection.customHandle = customHandle;
    selection.appendChild(customHandle);

    document.getElementById("blended-content").appendChild(selection);
    $(selection).draggable({
      containment: "#blended-content",
      start: function () {
        this.classList.add("dragging");
      },
      stop: function () {
        this.classList.remove("dragging");
      }
    });
    selections.push(selection);
    setCurrentSelection(selection);

    selection.focus();

    document.addEventListener("mousemove", resizeSelection);
    document.addEventListener("mouseup", finalizeSelection);
    enableCustomResize(selection);
}

function resizeSelection(e) {
    if (!isSelecting) return;
    let selection = currentSelection;

    let endX = e.clientX;
    let endY = e.clientY;

    selection.style.width = `${Math.abs(endX - startX)}px`;
    selection.style.height = `${Math.abs(endY - startY)}px`;
    selection.style.left = `${Math.min(startX, endX)}px`;
    selection.style.top = `${Math.min(startY, endY)}px`;
    selection.tabIndex = 0; // allow programmatic focus
selection.focus();
}



function finalizeSelection() {
    isSelecting = false;
    let selection = currentSelection;
    if (!selection || selection.offsetWidth < 70 || selection.offsetHeight < 70) {
        selection.remove();
        selections.pop();
        return;
    }

    selection.tabIndex = 0;

    const paragraph = document.createElement("p");
    paragraph.innerText = dummyTexts[Math.floor(Math.random() * dummyTexts.length)];
    paragraph.style.margin = "0";
    paragraph.style.padding = "0";
    paragraph.style.whiteSpace = "pre-wrap";
    paragraph.style.wordBreak = "break-word";
    paragraph.style.outline = "none";
    paragraph.style.cursor = "text";
    paragraph.style.mixBlendMode = "inherit"; // inherit parent mix blend
    paragraph.style.color = "inherit"; // inherit parent color
    paragraph.style.font = "inherit"; // inherit all font styles
    paragraph.setAttribute("contenteditable", "true");
    paragraph.setAttribute("tabindex", "0");

    selection.innerHTML = ""; // Clear any existing content (handle will be re-appended below)
    selection.setAttribute("tabindex", "0");
    selection.focus();
    const contentWrapper = document.createElement("div");
    contentWrapper.classList.add("selection-content");
    contentWrapper.appendChild(paragraph);
    selection.appendChild(contentWrapper);
    selection.appendChild(selection.customHandle); // Re-append the resize handle
    if (paragraph && typeof paragraph.focus === 'function') {
      paragraph.focus();
    }

    setCurrentSelection(selection); // <-- auto-select on creation

    selection.style.color = getRandomColor();
    // Set font size based on selection height
    const selH = selection.offsetHeight;
    let fontPx;
    if (selH < 150) {
      // For short boxes under 100px tall, keep font size below the box height
      const maxPx = Math.max(12, selH - 5);
      const minPx = 12;
      fontPx = Math.floor(Math.random() * (maxPx - minPx + 1)) + minPx;
    } else {
      // Scale with height for taller boxes
      const minPx = Math.max(16, Math.floor(selH * 0.12));   // lower bound ~12% of height
      const maxPx = Math.min(Math.floor(selH * 0.60), 300);  // upper bound capped at 300px
      const span = Math.max(1, maxPx - minPx + 1);
      fontPx = Math.floor(Math.random() * span) + minPx;
    }
    selection.style.fontSize = `${fontPx}px`;
    selection.style.display = "block";
    selection.style.alignItems = "left";
    selection.style.justifyContent = "left";
    selection.style.textAlign = "left";
    selection.style.overflow = "hidden";
    selection.style.padding = "5px";
    selection.style.wordBreak = "break-word";
    selection.style.wordWrap = "break-word";
    selection.style.fontFamily = (window.userFontName || "shape-font");
    selection.style.fontVariationSettings = `'SHAP' 1`;
    paragraph.style.fontVariationSettings = `'SHAP' 1`;

    document.removeEventListener("mousemove", resizeSelection);
    document.removeEventListener("mouseup", finalizeSelection);
    if (selection) { updateSliders(selection); }
    suppressClearOnce = true;
}



function enableCustomResize(selection) {
  const handle = selection.querySelector(".custom-resize-handle");
  let isResizing = false, startX, startY, startWidth, startHeight;

  handle.addEventListener("mousedown", function (e) {
    e.preventDefault();
    e.stopPropagation();
    isResizing = true;
    startX = e.clientX;
    startY = e.clientY;
    startWidth = selection.offsetWidth;
    startHeight = selection.offsetHeight;

    function onMouseMove(e) {
      if (!isResizing) return;
      const newWidth = startWidth + (e.clientX - startX);
      const newHeight = startHeight + (e.clientY - startY);
      selection.style.width = `${newWidth}px`;
      selection.style.height = `${newHeight}px`;
    }

    function onMouseUp() {
      isResizing = false;
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    }

    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
  });
}

// === Duo-tone slider background (match Spring version) ===
function updateSliderBackground(slider) {
  if (!slider) return;
  var min = Number(slider.min) || 0;
  var max = Number(slider.max) || 100;
  var val = Number(slider.value);
  var pct = ((val - min) / (max - min)) * 100;
  // Left = #34d3ff, Right = #fff04b
  slider.style.background = `linear-gradient(to right, #34d3ff 0%, #34d3ff ${pct}%, #fff04b ${pct}%, #fff04b 100%)`;
}
// Sliders to edit current selection only
document.getElementById("font-size-slider").addEventListener("input", function () {
  if (currentSelection) currentSelection.style.fontSize = this.value + "px";
  updateRangeBubble('font-size-slider', 'font-size-value', v => Math.round(v), 42);
  updateSliderBackground(this);
});
document.getElementById("line-height-slider").addEventListener("input", function () {
  if (currentSelection) currentSelection.style.lineHeight = this.value;
  updateRangeBubble('line-height-slider', 'line-height-value', v => Number(v).toFixed(2));
  updateSliderBackground(this);
});
document.getElementById("letter-spacing-slider").addEventListener("input", function () {
  if (currentSelection) {
    const percentage = Number(this.value) || 0;   // e.g., 100 → 1em
    const emValue = percentage / 100;
    currentSelection.style.letterSpacing = emValue + "em";
  }
  updateLetterSpacingBubble();
  updateSliderBackground(this);
});

// --- Combined transform for ratio and slant sliders ---
function updateCombinedTransform() {
  const selection = document.querySelector(".is-selected") || currentSelection;
  if (!selection) return;

  const ratio = parseFloat(document.getElementById("ratio").value);
  const slant = parseFloat(document.getElementById("slant").value);

  const skewX = Math.tan(slant * Math.PI / 180); // X-axis skew from slant degrees
  const transform = `matrix(1, 0, ${skewX}, ${ratio}, 0, 0)`;

  selection.style.transform = transform;
}

document.getElementById("slant").addEventListener("input", function () {
  updateCombinedTransform();
  updateRangeBubble('slant', 'slant-value', v => Math.round(v), 42);
  updateSliderBackground(this);
});

document.getElementById("ratio").addEventListener("input", function () {
  updateCombinedTransform();
  updateRangeBubble('ratio', 'ratio-value', v => parseFloat(v).toFixed(2), 42);
  updateSliderBackground(this);
});



function updateSliders(sel) {
  const style = window.getComputedStyle(sel);
  document.getElementById("font-size-slider").value = parseInt(style.fontSize);
  updateSliderBackground(document.getElementById('font-size-slider'));
  updateRangeBubble('font-size-slider', 'font-size-value', v => Math.round(v), 42);

  // Convert computed line-height (usually px) to unitless multiplier for the slider
  (function () {
    const lhPx = parseFloat(style.lineHeight);
    const fsPx = parseFloat(style.fontSize);
    let multiplier = 1;
    if (!Number.isNaN(lhPx) && !Number.isNaN(fsPx) && fsPx > 0) {
      multiplier = lhPx / fsPx;
    }
    // Clamp to slider range [0.1, 3]
    multiplier = Math.max(0.1, Math.min(3, multiplier));
    const lhSlider = document.getElementById("line-height-slider");
    lhSlider.value = multiplier.toFixed(2);
    updateSliderBackground(lhSlider);
    updateRangeBubble('line-height-slider', 'line-height-value', v => Number(v).toFixed(2));
  })();

  (function () {
    const lsRaw = style.letterSpacing;               // may be 'normal' or e.g. '3.2px'
    const fsPx = parseFloat(style.fontSize) || 16;   // fallback just in case
    let percentage = 0;
    if (lsRaw !== 'normal') {
      const lsPx = parseFloat(lsRaw);                // computed is usually px
      if (!Number.isNaN(lsPx) && fsPx > 0) {
        percentage = (lsPx / fsPx) * 100;           // px → %
      }
    }
    document.getElementById("letter-spacing-slider").value = percentage;
    updateSliderBackground(document.getElementById('letter-spacing-slider'));
    updateLetterSpacingBubble();
  })();

  // --- Updated transform parsing for slant and ratio ---
  const transform = style.transform;
  const slantInput = document.getElementById("slant");
  const ratioInput = document.getElementById("ratio");

  if (transform && transform !== "none") {
    const matrixMatch = transform.match(/matrix\(([^)]+)\)/);
    if (matrixMatch) {
      const values = matrixMatch[1].split(",").map(Number);
      const a = values[0], c = values[2], d = values[3];

      // Slant calculation (skewX in degrees)
      let slantDeg = Math.atan(c) * (180 / Math.PI);
      slantDeg = Math.max(parseFloat(slantInput.min), Math.min(parseFloat(slantInput.max), slantDeg));
      slantInput.value = String(Math.round(slantDeg));

      // Ratio calculation (scaleY)
      const ratio = d;
      ratioInput.value = ratio.toFixed(2);

      updateSliderBackground(slantInput);
      updateRangeBubble('slant', 'slant-value', v => Math.round(v), 42);
      updateSliderBackground(ratioInput);
      updateRangeBubble('ratio', 'ratio-value', v => parseFloat(v).toFixed(2), 42);
    }
  } else {
    slantInput.value = "0";
    ratioInput.value = "1";
    updateSliderBackground(slantInput);
    updateRangeBubble('slant', 'slant-value', v => Math.round(v), 42);
    updateSliderBackground(ratioInput);
    updateRangeBubble('ratio', 'ratio-value', v => parseFloat(v).toFixed(2), 42);
  }

  // Sync color picker to the selection's current color
  const color = style.color;
  const rgba = color.match(/\d+/g).map(Number);
  if (typeof colorPicker !== 'undefined' && colorPicker && rgba) {
    colorPicker.color.rgb = { r: rgba[0], g: rgba[1], b: rgba[2] };
  }
}
// --- General bubble helpers for sliders ---
function ensureBubble(sliderId, bubbleId) {
  const slider = document.getElementById(sliderId);
  if (!slider) return null;
  let bubble = document.getElementById(bubbleId);
  if (!bubble) {
    bubble = document.createElement('span');
    bubble.id = bubbleId;
    bubble.className = 'slider-bubble';
    bubble.textContent = slider.value || '0';
    slider.insertAdjacentElement('afterend', bubble);
  }
  // Ensure parent is a positioning context
  const group = slider.parentElement;
  if (group && getComputedStyle(group).position === 'static') {
    group.style.position = 'relative';
  }
  return bubble;
}

function updateRangeBubble(sliderId, bubbleId, formatFn) {
  const slider = document.getElementById(sliderId);
  if (!slider) return;
  const bubble = ensureBubble(sliderId, bubbleId);
  if (!bubble) return;

  // Determine thumb width: data-* overrides CSS var, else fallback 42
  const cssThumb  = parseFloat(getComputedStyle(slider).getPropertyValue('--thumb-w'));
  const dataThumb = slider.dataset.thumbWidth ? parseFloat(slider.dataset.thumbWidth) : NaN;
  const thumbSize = (!Number.isNaN(dataThumb) && dataThumb > 0) ? dataThumb
                 : (!Number.isNaN(cssThumb)  && cssThumb  > 0) ? cssThumb
                 : 42;

  const rawVal = Number(slider.value);
  const displayVal = typeof formatFn === 'function' ? formatFn(rawVal) : Math.round(rawVal);
  bubble.textContent = displayVal;

  const styles = getComputedStyle(slider);
  const paddingLeft  = parseFloat(styles.paddingLeft)  || 0;
  const paddingRight = parseFloat(styles.paddingRight) || 0;
  const trackWidth = slider.clientWidth - paddingLeft - paddingRight;

  const min = Number(slider.min) || 0;
  const max = Number(slider.max) || 100;
  const percent = (rawVal - min) / (max - min);

  // Center of the thumb along the track
  let centerX = paddingLeft + percent * (trackWidth - thumbSize) + thumbSize / 2;

  // Clamp within track
  const leftBound  = paddingLeft + thumbSize / 2;
  const rightBound = paddingLeft + trackWidth - thumbSize / 2;
  centerX = Math.max(leftBound, Math.min(centerX, rightBound));

  // Essential styles (visuals come from CSS)
  if (!bubble.style.top) bubble.style.top = '0px';
  bubble.style.position = 'absolute';
  bubble.style.transform = 'translateX(-50%)';
  bubble.style.pointerEvents = 'none';
  bubble.style.userSelect = 'none';
  if (!bubble.style.zIndex) bubble.style.zIndex = '10';

  bubble.style.left = centerX + 'px';
}

function updateLetterSpacingBubble() {
  const slider = document.getElementById('letter-spacing-slider');
  if (!slider) return;

  // Ensure parent is a positioning context
  const group = slider.parentElement;
  if (group && getComputedStyle(group).position === 'static') {
    group.style.position = 'relative';
  }

  // Ensure bubble exists
  let bubble = document.getElementById('letter-spacing-value');
  if (!bubble) {
    bubble = document.createElement('span');
    bubble.id = 'letter-spacing-value';
    bubble.className = 'slider-bubble';
    bubble.textContent = '0';
    (group || slider.parentElement || document.body).appendChild(bubble);
  }

  // Update label text (just the number)
  const val = Number(slider.value) || 0;
  bubble.textContent = Math.round(val);

  // Compute the center X of the thumb over the track
  const styles = getComputedStyle(slider);
  const paddingLeft = parseFloat(styles.paddingLeft) || 0;
  const paddingRight = parseFloat(styles.paddingRight) || 0;
  const trackWidth = slider.clientWidth - paddingLeft - paddingRight;

  // Thumb width: match CSS for #letter-spacing-slider (30px); fallback to 20px
  const cssThumb = parseFloat(getComputedStyle(slider).getPropertyValue('--thumb-w'));
const thumbSize = (!Number.isNaN(cssThumb) && cssThumb > 0) ? cssThumb : 42;

  const min = Number(slider.min) || 0;
  const max = Number(slider.max) || 100;
  const percent = (val - min) / (max - min);

  // Center of the thumb along the track
  let centerX = paddingLeft + percent * (trackWidth - thumbSize) + thumbSize / 2;

  // Clamp so the bubble's center stays within the track bounds
  const leftBound = paddingLeft + thumbSize / 2;
  const rightBound = paddingLeft + trackWidth - thumbSize / 2;
  centerX = Math.max(leftBound, Math.min(centerX, rightBound));

  // Ensure essential styles for centering/visibility
  bubble.style.position = 'absolute';
  if (!bubble.style.top) bubble.style.top = '0px';
  bubble.style.transform = 'translateX(-50%)';
  bubble.style.pointerEvents = 'none';
  bubble.style.userSelect = 'none';
  if (!bubble.style.zIndex) bubble.style.zIndex = '10';

  // Place bubble so its center aligns with the thumb center
  bubble.style.left = centerX + 'px';
}

window.addEventListener('resize', updateLetterSpacingBubble);
window.addEventListener('DOMContentLoaded', updateLetterSpacingBubble);
window.addEventListener('resize', function(){
  updateRangeBubble('font-size-slider', 'font-size-value', v => Math.round(v));
  updateRangeBubble('line-height-slider', 'line-height-value', v => Number(v).toFixed(2));
  updateRangeBubble('slant', 'slant-value', v => Math.round(v));
  document.querySelectorAll("input[type='range']").forEach(function(slider){ updateSliderBackground(slider); });
});
window.addEventListener('DOMContentLoaded', function(){
  updateRangeBubble('font-size-slider', 'font-size-value', v => Math.round(v));
  updateRangeBubble('line-height-slider', 'line-height-value', v => Number(v).toFixed(2));
  updateRangeBubble('slant', 'slant-value', v => Math.round(v));
  document.querySelectorAll("input[type='range']").forEach(function(slider){
    updateSliderBackground(slider);
    slider.addEventListener('input', function(){ updateSliderBackground(this); });
  });
});

function getRandomColor() {
  return `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
}


     ///----------------- [  ABOUT PAGE _ Pop-Up Window  ] -----------------
     ///////////////////////////////////////////////////////////////////////

     document.getElementById("about").addEventListener("click", function () {
        let popup = document.getElementById("about-popup");
        let isCreating = false;

        if (!popup) {
            popup = document.createElement("div");
            popup.id = "about-popup";
            popup.style.position = "fixed";
            popup.style.width = "475px";
            popup.style.maxHeight = "475px"; // Set max height
            popup.style.overflow = "auto"; // Enable scroll bar when content is too long
            popup.style.height = "auto";
            popup.style.background = "#ff489a";
            popup.style.color = "black";
            popup.style.fontFamily = "authentic-sans-90"
            popup.style.lineHeight = "120%"
            popup.style.padding = "25px 25px 25px 33px";
            popup.style.textAlign = "left";
            popup.style.top = "50%";
            popup.style.left = "50%";
            popup.style.outline = "4px solid #fff04b";
            popup.style.borderRadius = "25px";
            popup.style.transform = "translate(-50%, -50%)";
            popup.style.zIndex = "1000";
            popup.innerHTML = `
  <span id="close-popup" style="
      position: absolute;
      top: 18px;
      right: 17px;
      cursor: pointer;
      font-size: 21px;
      font-weight: 900;">

      ✕
      
      </span>
      
   <p class="pop-up" style="margin-bottom: 17px;margin-top: 10px;"><span style="font-family: authentic-sans-130;">Illegible Pattern</span> is a web tool that generates randomized geometric patterns using an illegible typeface.</p>
        
   <p class="pop-up" style="text-indent: 22px; color:yellow; mix-blend-mode: normal; "> 
         <span style="text-decoration: underline; text-underline-offset: 3px;">Drag and drop</span> on the blank canvas to start your pattern!
    </p>
    <p class="pop-up" style="text-indent: 50px; color:yellow; mix-blend-mode: normal; margin-bottom: 19px;">      
        You can <span style="text-decoration: underline; text-underline-offset: 3px;">move</span> them around and <span style="text-decoration: underline; text-underline-offset: 3px;">type in</span> to edit.
    </p>
         
        
        <p class="pop-up" style=" margin-bottom: 2px;"> A custom variable font Modular Shapes, which includes both rectangular and circular mode, let users create abstract pattern composition by typing. This project is designed and coded by Jo Zixuan during RISD Graphic Design MFA. </p>
        <p class="pop-up" style=" margin-bottom: 0px;"> Share the patterns you make with this tool to our <a href="https://www.are.na/jo-zixuan/illegible-pattern" target="_blank" style="mix-blend-mode: normal; color:purple; ">gallery</a>!</p>
         
`;
            document.body.appendChild(popup);
            isCreating = true;

            document.getElementById("close-popup").addEventListener("click", function () {
                popup.remove();
            });
        } else {
            popup.remove();
        }
    });

///////////////------- [  GLYPHS CHART _ Pop-Up Window  ] ---------------- //////////////////////////////////////////////////////////////////////////-->
document.getElementById("chart").addEventListener("click", function () {
            let popup = document.getElementById("chart-popup");

            if (!popup) {
                popup = document.createElement("div");
                popup.id = "chart-popup";
                popup.style.position = "fixed";
                popup.style.width = "600px";
                popup.style.maxHeight = "411px"; // Set max height
                popup.style.overflow = "auto"; // Enable scroll bar when content is too long
                popup.style.height = "auto";
                popup.style.background = "#3fbd48";
                popup.style.color = "black";
                popup.style.fontFamily = "authentic-sans-90"
                popup.style.fontSize = "13px"
                popup.style.letterSpacing = "111%"
                popup.style.color = "white"
                popup.style.lineHeight = "120%"
                popup.style.padding = "20px";
                popup.style.paddingRight = "30px";
               
                popup.style.textAlign = "left";
                popup.style.outline = "5px solid #fff04b";
                popup.style.borderRadius = "0 15px 0 0"; // round only the top-right corner
                popup.style.bottom = "0%";
                popup.style.left = "0%";
                // popup.style.top = "50%";
                // popup.style.left = "50%";
                // popup.style.transform = "translate(-50%, -50%)";
                popup.style.zIndex = "1000";
               popup.innerHTML = `
      <span id="close-chart-popup" style="
          position: absolute;
          top: 17px;
          right: 15px;
          cursor: pointer;
          font-size: 21px;
          font-weight: 500;">

          ✕
          
          </span>
          
      <p style="margin-bottom: 5px;mix-blend-mode:normal; font-family: authentic-sans-90;">Rectangular mode</p>
      <img src="rectangular-chart.svg" alt='Chart explaining what the abstract shapes' correspoding keyboard input style=" width:600px;mix-blend-mode: normal;">
      <p style="margin-top: 10px;margin-bottom: 5px;mix-blend-mode:normal; font-family: authentic-sans-90;">Circular mode</p>
      <img src="circular-chart.svg" alt='Chart explaining what the abstract shapes' correspoding keyboard input style=" width:600px;mix-blend-mode: normal;">
  `;
                document.body.appendChild(popup);

                document.getElementById("close-chart-popup").addEventListener("click", function () {
                    popup.remove();
                });
            } else {
                popup.remove();
            }
        });


//  //////////////////////////////////////
// -------------------- [  Toggle between Shape and Meaning  ] ---------------- //////////////////////////////////////////////////////////////////////////-->
    


document.getElementById("meaning").addEventListener("click", function () {
    // Prefer current selection; fallback to last-created selection
    const target = currentSelection || selections[selections.length - 1] || null;
    if (!target) return;

    const user = window.userFontName || null;
    const currentFont = getComputedStyle(target).fontFamily;
    let next;

    if (user) {
      // Toggle between shape-font and the user-uploaded font
      next = currentFont.includes("shape-font") ? user : "shape-font";
    } else {
      // Fallback: toggle between shape-font and Authentic Sans
      next = currentFont.includes("shape-font") ? "authentic-sans-130" : "shape-font";
    }

    target.style.fontFamily = next;
    const p = target.querySelector("p");
    if (p) p.style.fontFamily = "inherit";
});



//  ///////////////////////////////////
// -------------------- [  Toggle between Multiply and Solid  ] ---------------- //////////////////////////////////////////////////////////////////////////-->
    
// document.getElementById("color-mode").addEventListener("click", function () {
//     let paragraphs = document.querySelectorAll("p");
//     paragraphs.forEach(p => {
//         let currentBlendMode = window.getComputedStyle(p).mixBlendMode;
//         if (currentBlendMode === "multiply") {
//             p.style.mixBlendMode = "normal";
//         } else {
//             p.style.mixBlendMode = "multiply";
//         }
//     });
// });

        ////////////////////////
        //   --------     Function to play sound     --------  //////////////

        function playSound(soundFile) {
            let audio = new Audio(soundFile);
            audio.play();
        }

        // Assign different sounds to buttons
        // document.getElementById("save-svg-btn").addEventListener("click", function () {
        //     playSound("audio/button1.wav");
        // });

        document.getElementById("save-png-btn").addEventListener("click", function () {
            playSound("audio/button2.wav");
        });

        document.getElementById("chart").addEventListener("click", function () {
            playSound("audio/button3.wav");
        });

        document.getElementById("about").addEventListener("click", function () {
            playSound("audio/button4.wav");
        });

        document.getElementById("meaning").addEventListener("click", function () {
            playSound("audio/button5.wav");
        });

        document.getElementById("greyscale").addEventListener("click", function () {
            playSound("audio/button6.wav");
        });
        // document.getElementById("text-alignment").addEventListener("click", function () {
        //     playSound("audio/alignment-audio.wav");
        // });
        document.getElementById("decoration").addEventListener("click", function () {
            playSound("audio/decoration.wav");
        });

        document.getElementById("delete").addEventListener("click", function () {
            playSound("audio/button8.wav");
            if (currentSelection) {
                currentSelection.remove();
                setCurrentSelection(null);
            }
        });

        // Play sound effect when slider thumb is released
        document.querySelectorAll("input[type='range']").forEach(slider => {
            slider.addEventListener("change", function () {
                playSound("audio/click3.wav");
            });
        });

// ---------------- [ Import Font Button ] ----------------
(function(){
  const importBtn = document.getElementById("import-font");
  if (!importBtn) return;

  // Hidden file input to pick font files
  const fontInput = document.createElement("input");
  fontInput.type = "file";
  fontInput.accept = ".ttf,.otf,.woff,.woff2";
  fontInput.style.display = "none";
  document.body.appendChild(fontInput);

  // Hover popup with instructions
  importBtn.addEventListener("mouseover", function(){
    let popup = document.getElementById("import-font-popup");
    if (!popup) {
      popup = document.createElement("div");
      popup.id = "import-font-popup";
      popup.innerHTML = `<p style="font-family: authentic-sans-90; font-size= 50px;mix-blend-mode: normal;">Click to upload your own font file.<br>
It will replace the current pattern font.</p>`;
      popup.style.width = "318px";
      popup.style.height = "70px";
      popup.style.position = "fixed";
      popup.style.display = "flex";
      popup.style.justifyContent = "center";
      popup.style.alignItems = "center";
      popup.style.textAlign = "left";
      popup.style.lineHeight = "150%";
      popup.style.background = "#ff489a";
      popup.style.mixBlendMode = "solid";
      popup.style.border = "3px solid rgb(255, 240, 75)";
      popup.style.borderRadius = "25px";
      popup.style.zIndex = "1000";
      popup.style.pointerEvents = "none";
      popup.style.top = "337px";
      popup.style.left = "75px";
      popup.style.padding = "3px 0px 0px 5px";
      document.body.appendChild(popup);
    }
  });
  importBtn.addEventListener("mouseleave", function(){
    const popup = document.getElementById("import-font-popup");
    if (popup) popup.remove();
  });

  // Click to open file picker
  importBtn.addEventListener("click", function(){
    fontInput.click();
  });

  // Load chosen font and apply to all selections/patterns
  fontInput.addEventListener("change", async function(event){
    const file = event.target.files && event.target.files[0];
    if (!file) return;

    try {
      const url = URL.createObjectURL(file);
      const userFontName = "user-font"; // Consistent family name
      const fontFace = new FontFace(userFontName, `url(${url})`);
      await fontFace.load();
      document.fonts.add(fontFace);
      window.userFontName = userFontName; // remember for future selections

      // Apply to all current dynamic selections
      document.querySelectorAll('.selection').forEach(sel => {
        sel.style.fontFamily = userFontName;
        const p = sel.querySelector('p');
        if (p) p.style.fontFamily = 'inherit';
      });

      // Also apply to any paragraph inside the main container as a safety net
      document.querySelectorAll('#blended-content p').forEach(p => {
        const parent = p.closest('.selection');
        if (!parent) {
          p.style.fontFamily = userFontName;
        }
      });
    } catch (err) {
      console.error('Failed to load font:', err);
    }
  });
})();


//  <!-- SHAP Variable Axis changes when clicked -->
//   <!-- toggle between shap 1 rectangular  & 4 circular -->
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("p").forEach(p => {
        p.addEventListener("click", function () {
            this.classList.toggle("shap-4"); // Toggle the class
        });
    });
});


//________________________<< Import Image as background  >>__________________
// __________________________This function is cancelled________________
// document.addEventListener("DOMContentLoaded", () => {
//     const fileInput = document.createElement("input");
//     fileInput.type = "file";
//     fileInput.accept = "image/*";
//     fileInput.style.display = "none"; // Keep it hidden, but accessible via button

//     // Append file input to body
//     document.body.appendChild(fileInput);

//     // Get the import button
//     const importButton = document.getElementById("import");

//     // Click event to trigger file selection
//     importButton.addEventListener("click", () => {
//         fileInput.click();
//     });

//     // Handle file selection
//     fileInput.addEventListener("change", (event) => {
//         const file = event.target.files[0];
//         if (file && file.type.startsWith("image/")) {
//             const reader = new FileReader();
//             reader.onload = (e) => {
//                 document.body.style.backgroundImage = `url('${e.target.result}')`;
//                 document.body.style.backgroundSize = "100vw auto";
//                 document.body.style.backgroundPosition = "top center";
//                 document.body.style.backgroundRepeat = "no-repeat";
//             };
//             reader.readAsDataURL(file);
//         }
//     });

//     // Drag and Drop functionality
//     document.body.addEventListener("dragover", (event) => {
//         event.preventDefault();
//         document.body.style.opacity = "0.8";
//     });

//     document.body.addEventListener("dragleave", () => {
//         document.body.style.opacity = "1";
//     });

//     document.body.addEventListener("drop", (event) => {
//         event.preventDefault();
//         document.body.style.opacity = "1";

//         const file = event.dataTransfer.files[0];
//         if (file && file.type.startsWith("image/")) {
//             const reader = new FileReader();
//             reader.onload = (e) => {
//                 document.body.style.backgroundImage = `url('${e.target.result}')`;
//                 document.body.style.backgroundSize = "100vw auto";
//                 document.body.style.backgroundPosition = "top center";
//                 document.body.style.backgroundRepeat = "no-repeat";
//             };
//             reader.readAsDataURL(file);
//         }
//     });
// });

//save png function//
document.getElementById("save-png-btn").addEventListener("click", function () {
    playSound("audio/button2.wav");

    const target = document.getElementById("blended-content");

    const paragraphs = target.querySelectorAll(".selection p");
    const originalSettings = [];

    paragraphs.forEach(p => {
        const currentFontVariation = p.style.fontVariationSettings || getComputedStyle(p).getPropertyValue("font-variation-settings");
        originalSettings.push({
            el: p,
            fontVariationSettings: p.style.fontVariationSettings
        });
        p.style.fontVariationSettings = currentFontVariation;
    });

    html2canvas(target, {
        allowTaint: true,
        useCORS: true,
        backgroundColor: null
    }).then(canvas => {
        const link = document.createElement("a");
        link.download = "illegible-pattern.png";
        link.href = canvas.toDataURL("image/png");
        link.click();

            // Restore original inline styles
            originalSettings.forEach(({ el, fontVariationSettings }) => {
                el.style.fontVariationSettings = fontVariationSettings;
            });
            originalFilters.forEach(({ el, filter }) => {
                el.style.filter = filter;
            });
            originalDecorations.forEach(({ el, textDecoration }) => {
                el.style.textDecoration = textDecoration;
            });
    });
});
//________________________<< Greyscale Function button >>_________________________ _____________________________________________________________________

document.addEventListener("DOMContentLoaded", () => {
    const greyscaleButton = document.getElementById("greyscale");
    let isGreyscale = false;

    greyscaleButton.addEventListener("click", () => {
        isGreyscale = !isGreyscale;
        document.querySelectorAll("p").forEach(p => {
            if (isGreyscale) {
                p.style.filter = "grayscale(100%)"; // Apply greyscaleeffect
            } else {
                p.style.filter = "none"; // Remove greyscale
            }
        });
    });
});

//________________________<< Text Alignment Function button >>_________________________ _____________________________________________________________________

// document.addEventListener("DOMContentLoaded", () => {
//     const textAlignmentButton = document.getElementById("text-alignment");
//     const alignments = ["left", "center", "right"];
//     let currentAlignmentIndex = 0;

//     textAlignmentButton.addEventListener("click", () => {
//         currentAlignmentIndex = (currentAlignmentIndex + 1) % alignments.length;
//         document.querySelectorAll("p").forEach(p => {
//             p.style.textAlign = alignments[currentAlignmentIndex];
//         });
//     });
// });

//________________________<< Text Decoration Toggle >>_________________________
document.addEventListener("DOMContentLoaded", () => {
    const decorationButton = document.getElementById("decoration");
    const decorations = ["none", "underline", "overline", "line-through"];
    let currentDecorationIndex = 0;

    decorationButton.addEventListener("click", () => {
        if (!currentSelection) return;
        const paragraph = currentSelection.querySelector("p");
        if (paragraph) {
            currentDecorationIndex = (currentDecorationIndex + 1) % decorations.length;
            paragraph.style.textDecoration = decorations[currentDecorationIndex];
        }
    });
});

// //Improve Click Handling
// document.addEventListener("click", (e) => {
//   const sel = e.target.closest(".selection");
//   if (sel) {
//     setCurrentSelection(sel);
//     updateSliders(currentSelection);
//     updateToggleFromSelection(currentSelection);
//   }
// });
    
// Inject custom styles for selection and custom resize handle
const style = document.createElement('style');
style.textContent = `
.selection {
  cursor: text;
  position: relative;
}

.selection:focus-within,
.selection:hover,
.selection.is-selected {
    outline: 3px dotted rgb(255, 105, 188);
    outline-offset: -3px;
}

.custom-resize-handle {
  width: 17px;
  height: 17px;
  background: hotpink;
  clip-path: polygon(25% 0, 63% 37%, 100% 0, 100% 100%, 0 100%, 38% 62%, 0 25%);

  position: absolute;
  right: 0;
  bottom: 0;
  cursor: se-resize;
  display: none;
}

.selection:hover .custom-resize-handle,
.selection:focus-within .custom-resize-handle,
.selection.is-selected .custom-resize-handle {
  display: block;
}
 .selection:hover {
   cursor: grab;
 }
 .selection.dragging {
   cursor: grabbing !important;
 }`;
document.head.appendChild(style);

// // ===== NEW FUNCTION LABELS SYSTEM =====

// const BUTTON_LABELS = [
//   { id: "about", label: "About" },
//   { id: "chart", label: "Chart" },
//   { id: "meaning", label: "Legible" },
//   { id: "greyscale", label: "Greyscale" },
//   { id: "toggle-switch", label: "Shape" },
//   { id: "picker1", label: "Color" },
//   { id: "decoration", label: "Underline" },
//   { id: "import-font", label: "Import Font" },
//   { id: "save-png-btn", label: "Save" },
//   { id: "delete", label: "Delete" },
// ];

// const SLIDER_LABELS = [
//   { id: "font-size-slider", label: "Font Size" },
//   { id: "line-height-slider", label: "Line Height" },
//   { id: "letter-spacing-slider", label: "Letter Spacing" },
//   { id: "slant", label: "Slant" },
// ];

// function createFunctionLabels() {
//   const buttonBar = document.createElement("div");
//   buttonBar.id = "button-labels";
//   buttonBar.className = "button-labels-bar";
//   document.querySelector(".button-rail").appendChild(buttonBar);

//   const sliderBar = document.createElement("div");
//   sliderBar.id = "slider-labels";
//   sliderBar.className = "slider-labels-bar";
//   document.querySelector(".slider-container").appendChild(sliderBar);

//   BUTTON_LABELS.forEach(({ id, label }) => {
//     const el = document.getElementById(id);
//     if (!el) return;
//     const span = document.createElement("div");
//     span.className = "function-label btn-label";
//     span.dataset.for = id;
//     span.textContent = label;
//     buttonBar.appendChild(span);
//   });

//   SLIDER_LABELS.forEach(({ id, label }) => {
//     const el = document.getElementById(id);
//     if (!el) return;
//     const span = document.createElement("div");
//     span.className = "function-label slider-label";
//     span.dataset.for = id;
//     span.textContent = label;
//     sliderBar.appendChild(span);
//   });

//   positionFunctionLabels();
// }

// function positionFunctionLabels() {
//   const buttonBar = document.getElementById("button-labels");
//   const sliderBar = document.getElementById("slider-labels");
//   if (!buttonBar || !sliderBar) return;

//   BUTTON_LABELS.forEach(({ id }) => {
//     const el = document.getElementById(id);
//     const label = buttonBar.querySelector(`.btn-label[data-for="${id}"]`);
//     if (!el || !label) return;
//     label.style.left = `${el.offsetLeft + el.offsetWidth + 1}px`;
// label.style.top = `${el.offsetTop + el.offsetHeight / 7}px`;
//   });

//   SLIDER_LABELS.forEach(({ id }) => {
//     const el = document.getElementById(id);
//     const label = sliderBar.querySelector(`.slider-label[data-for="${id}"]`);
//     if (!el || !label) return;
//     label.style.left = `${el.offsetLeft + el.offsetWidth / 2}px`;
// label.style.top = `${el.offsetTop + el.offsetHeight + 20}px`;
//   });
// }

// window.addEventListener("resize", positionFunctionLabels);
// window.addEventListener("DOMContentLoaded", () => {
//   createFunctionLabels();
// });
// Helper: place caret at mouse position inside a contenteditable element
function placeCaretAtPoint(el, clientX, clientY) {
  if (!el) return;
  const sel = window.getSelection();
  if (!sel) return;
  const range = document.createRange();

  // Modern API
  if (document.caretPositionFromPoint) {
    const pos = document.caretPositionFromPoint(clientX, clientY);
    if (pos && pos.offsetNode) {
      range.setStart(pos.offsetNode, Math.min(pos.offset, (pos.offsetNode.nodeValue || '').length || 0));
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
      return;
    }
  }
  // WebKit/Blink fallback
  if (document.caretRangeFromPoint) {
    const r = document.caretRangeFromPoint(clientX, clientY);
    if (r) {
      sel.removeAllRanges();
      sel.addRange(r);
      return;
    }
  }
  // Last resort: put caret at end
  range.selectNodeContents(el);
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
}

// Make text editable and set caret exactly where clicked
document.addEventListener('mousedown', function (e) {
  const p = e.target.closest('.selection-content p');
  if (!p) return;
  p.setAttribute('contenteditable', 'true');
  // Avoid native selection flicker; we’ll place the caret ourselves
  e.preventDefault();
  p.focus();
  placeCaretAtPoint(p, e.clientX, e.clientY);
}, true); // capture phase so this runs first

// Toggle SHAP axis using toggle switch
document.getElementById("toggle-switch").addEventListener("change", function () {
    if (currentSelection) {
        const paragraph = currentSelection.querySelector("p");
        const newVal = this.checked ? 4 : 1;
        if (paragraph) {
            paragraph.style.fontVariationSettings = `'SHAP' ${newVal}`;
        }
    }
});
// Sync shape toggle with current selection
function updateToggleFromSelection(sel) {
    const toggle = document.getElementById("toggle-switch");
    const paragraph = sel.querySelector("p");
    if (!paragraph) {
        toggle.checked = false;
        return;
    }

    //  ensures it always reads the visible value, not just inline.
    let settings = getComputedStyle(paragraph).getPropertyValue("font-variation-settings");

    const match = settings.match(/'SHAP'\s*([0-9.]+)/);
    if (match) {
        toggle.checked = parseFloat(match[1]) === 4;
    } else {
        toggle.checked = false;
    }
}
// Update toggle when selection is clicked
document.addEventListener("click", (e) => {
    if (suppressClearOnce) {
      suppressClearOnce = false; // consume this click (likely the post-drag click)
      return;
    }
    const sel = e.target.closest(".selection");
    if (sel) {
        setCurrentSelection(sel);
        updateSliders(sel);
        updateToggleFromSelection(sel);
        const p = sel.querySelector('p');
        if (p) {
            p.setAttribute('contenteditable', 'true');
            p.focus();
            // If no selection ranges exist (e.g., programmatic focus), put caret at end by default
            const selObj = window.getSelection();
            if (selObj && selObj.rangeCount === 0) {
              const r = document.createRange();
              r.selectNodeContents(p);
              r.collapse(false);
              selObj.addRange(r);
            }
        }
    }
    // Clear selection if clicking on empty canvas area (inside #blended-content but not on a .selection)
    else if (e.target.closest('#blended-content') && !e.target.closest('.selection')) {
        setCurrentSelection(null);
    }
});


    ///test out spcial color picker///
    var colorPicker = new iro.ColorPicker('#picker1',{
        width: 120,
        color: "#f00",// Set the initial color to pure red
        display:"flex",
        margin:0,
        borderWidth:8,
        layout: [
            { 
            component: iro.ui.Slider,
            options: {
                sliderType: 'hue',
                
            }
            },
            { 
            component: iro.ui.Slider,
            options: {
                sliderType: 'saturation',
                
                }
            },
            { 
            component: iro.ui.Slider,
            options: {
                sliderType: 'value',
                }
            },
        ]
    });

    // Keep picker in sync with the currently selected box color
    colorPicker.on('color:change', function(color) {
      if (currentSelection) {
        currentSelection.style.color = color.hexString;
      }
    });


    //Close the advance pop-up window to explain the function
//     document.addEventListener("click", function (e) {
//   if (e.target.classList.contains("close-popup")) {
//     const popup = e.target.closest("div[id$='popup']");
//     if (popup) popup.remove();
//   }
// });


// ===== Gallery Pane (bottom-right) =====
(function initGalleryPane() {
  function buildGalleryPane() {
    // If it already exists, don't duplicate
    let gallery = document.getElementById('gallery');
    if (gallery) return gallery;

    gallery = document.createElement('div');
    gallery.id = 'gallery';
    // Position & sizing per spec
    gallery.style.position = 'fixed';
    gallery.style.right = '0';
    gallery.style.bottom = '0';
    gallery.style.width = '30vw';            
    gallery.style.height = 'calc(100vh - 130px)';
    // Visuals (match chart popup style)
    gallery.style.background = 'black';     // yellow as gallery background 
    gallery.style.color = 'white';
    gallery.style.outline = '5px solid #fff04b';
    gallery.style.borderRadius = "20px 0 0 0";
    // gallery.style.borderRadius = '20px';
    gallery.style.zIndex = '1000';
    gallery.style.display = 'flex';
    gallery.style.flexDirection = 'column';
    gallery.style.overflow = 'hidden';        // header fixed, inner scrolls
    gallery.style.fontFamily = 'authentic-sans-90, sans-serif';

    // Header (title + delete button)
    const header = document.createElement('div');
    header.className = 'gallery-header';
    header.style.display = 'flex';
    header.style.alignItems = 'center';
    header.style.justifyContent = 'space-between';
    header.style.fontSize = '15px';
    header.style.padding = '7px 12px';
    header.style.background = '#fff04b';
    header.style.color = '#000';

    const title = document.createElement('div');
    title.textContent = 'Illegible Pattern Gallery';
    title.style.fontWeight = '700';

    const closeBtn = document.createElement('span');
    closeBtn.id = 'close-gallery';
    closeBtn.textContent = '✕';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.fontSize = '18px';
    closeBtn.style.fontWeight = '900';
    closeBtn.style.padding = '0px 6px';

    header.appendChild(title);
    header.appendChild(closeBtn);

    // Scroll area for images
    const scroll = document.createElement('div');
    scroll.className = 'gallery-scroll';
    scroll.style.position = 'relative';
    scroll.style.flex = '1 1 auto';
    scroll.style.overflowY = 'auto';
    scroll.style.overflowX = 'hidden';
    scroll.style.padding = '0px 0px 0 3px';
    scroll.style.background = '#fff04b';

    // Image strip container
    const list = document.createElement('div');
    list.className = 'gallery-list';
    list.style.display = 'block';
    list.style.width = '100%';

    scroll.appendChild(list);

    // Append
    gallery.appendChild(header);
    gallery.appendChild(scroll);
    document.body.appendChild(gallery);

    // Close behavior: hide the gallery instead of removing it
    closeBtn.addEventListener('click', function() {
      gallery.style.display = 'none';
    });

    return gallery;
  }

  // Public helper: replace gallery content with an array of image URLs
  window.setGalleryImages = function(urls) {
    const gallery = buildGalleryPane();
    const list = gallery.querySelector('.gallery-list');
    list.innerHTML = '';
    (urls || []).forEach(function(src) {
      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '10px';

      const img = document.createElement('img');
      img.src = src;
      img.style.width = '100%';    // make all images same width as pane
      img.style.height = 'auto';
      img.style.display = 'block';

      wrapper.appendChild(img);
      list.appendChild(wrapper);
    });
  };

  // Auto-create the pane on load (empty; caller can populate via setGalleryImages)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', buildGalleryPane);
  } else {
    buildGalleryPane();
  }
})();

// ===== Wire Gallery Button to Toggle Gallery Pane =====
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('gallery-btn');
  if (!btn) return;
  btn.addEventListener('click', function(){
    const gallery = document.getElementById('gallery');
    if (!gallery) return;
    const isHidden = (gallery.style.display === 'none' || getComputedStyle(gallery).display === 'none');
    gallery.style.display = isHidden ? 'flex' : 'none';
  });
});

// Gallery-specific scrollbar styling (matching chart popup aesthetics)
(function injectGalleryScrollCSS(){
  const galleryScrollCSS = document.createElement('style');
  galleryScrollCSS.textContent = `
    #gallery .gallery-scroll::-webkit-scrollbar { width: 10px; }
    #gallery .gallery-scroll::-webkit-scrollbar-track 
    #gallery .gallery-scroll::-webkit-scrollbar-thumb 
    #gallery .gallery-scroll::-webkit-scrollbar-thumb:hover 
    /* Firefox */
    #gallery .gallery-scroll { scrollbar-width: thin; scrollbar-color: #fff04b #34d3ff; }
  `;
  document.head.appendChild(galleryScrollCSS);
})();

setGalleryImages([
   "gallery/pattern0.jpg",
  "gallery/pattern1.jpg",
  "gallery/pattern2.jpg",
  "gallery/pattern3.jpg",
  "gallery/pattern4.jpg",
  "gallery/pattern5.jpg",
  "gallery/pattern6.jpg",
  "gallery/pattern7.jpg",
  "gallery/pattern8.jpg",
  "gallery/pattern9.jpg",
  "gallery/pattern10.jpg",
  "gallery/pattern11.jpg",
  "gallery/pattern12.jpg",
  "gallery/pattern13.jpg",
  "gallery/pattern14.jpg",
  "gallery/pattern15.jpg",
  "gallery/pattern16.jpg",
  "gallery/pattern17.jpg",
  "gallery/pattern18.jpg",
  "gallery/pattern19.jpg",
  "gallery/pattern20.jpg",
  // "gallery/pattern21.jpg",
  "gallery/pattern22.jpg",
  "gallery/pattern23.jpg",
  "gallery/pattern25.jpg",
  "gallery/pattern26.jpg",
  "gallery/pattern27.jpg",
  "gallery/pattern28.jpg",
  "gallery/pattern24.jpg",
]);

window.addEventListener("DOMContentLoaded", function () {
    document.getElementById("about").click();
});
// Ensure the letter-spacing bubble exists (in case it was removed) and position it on load
document.addEventListener('DOMContentLoaded', function(){
  const slider = document.getElementById('letter-spacing-slider');
  if (slider && !document.getElementById('letter-spacing-value')) {
    const bubble = document.createElement('span');
    bubble.id = 'letter-spacing-value';
    bubble.className = 'slider-bubble';
    bubble.textContent = '0';
    slider.insertAdjacentElement('afterend', bubble);
  }
  if (typeof updateLetterSpacingBubble === 'function') {
    updateLetterSpacingBubble();
  }
});

// Dynamically position slider labels based on the center of their corresponding sliders
function positionSliderLabels() {
  const labels = document.querySelectorAll('.slider-label');
  labels.forEach(label => {
    const sliderId = label.dataset.for;
    const slider = document.getElementById(sliderId);
    if (!slider) return;

    const rect = slider.getBoundingClientRect();
    const containerRect = slider.offsetParent.getBoundingClientRect();

    label.style.position = "absolute";
    label.style.left = `${rect.left + rect.width / 2 - 152}px`;
    label.style.top = `${rect.bottom - 40}px`;
    label.style.transform = "translateX(-50%)";
  });
}

window.addEventListener("load", () => {
  positionSliderLabels();
});

window.addEventListener("resize", () => {
  positionSliderLabels();
});

window.addEventListener("load", () => {
  updateRangeBubble('ratio', 'ratio-value', v => parseFloat(v).toFixed(2), 42);
});

// Label toggle button logic
document.getElementById("instruction-btn").addEventListener("click", function () {
  const buttonLabels = document.getElementById("button-labels") || document.getElementById("button-label-container");
  const sliderLabels = document.getElementById("slider-labels") || document.getElementById("slider-label-container");

  if (!buttonLabels || !sliderLabels) return;

  // Use computed style in case display is not set inline
  const currentlyVisible = (buttonLabels.style.display !== "none");
  buttonLabels.style.display = currentlyVisible ? "none" : "block";
  sliderLabels.style.display = currentlyVisible ? "none" : "block";
});
</script>

</html>
